<!doctype html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>User Profile - Cyber Report RMS</title>
  <link href="../assets/css/style.css" rel="stylesheet">
</head>

<body>

  <!-- Navbar -->
  <nav class="navbar">
    <div class="container d-flex align-center justify-between">
      <span class="nav-brand">Cyber Incident Reporting RMS</span>
      <div class="d-flex align-center gap-4">
        <a href="reports.html" class="nav-link">Reports</a>
        <a href="profile.html" class="nav-link active">Profile</a>
        <button id="btnLogout" class="btn btn-secondary btn-sm" style="margin-left: 1rem;">Logout</button>
      </div>
    </div>
  </nav>

  <div class="container mb-4">
    <div id="alert" class="alert d-none" role="alert"></div>

    <div class="grid-layout">
      <!-- Left Column: Photo -->
      <div>
        <div class="card text-center">
          <h3 class="mb-4" style="font-size: 1.25rem;">Profile Photo</h3>

          <img id="profileImg" src="../assets/profile/default.jpg"
            style="width: 140px; height: 140px; border-radius: 50%; object-fit: cover; margin-bottom: 2rem; border: 4px solid var(--border);">

          <form id="photoForm" enctype="multipart/form-data">
            <div class="form-group">
              <input type="file" name="photo" id="photo" class="form-control" accept="image/*"
                style="font-size: 0.9rem;">
            </div>
            <button type="submit" class="btn btn-primary w-100 btn-sm">Update Photo</button>
          </form>
        </div>
      </div>

      <!-- Right Column: Details -->
      <div>
        <div class="card">
          <h3 class="mb-4" style="font-size: 1.25rem;">Account Details</h3>

          <form id="profileForm">
            <div class="form-group">
              <label class="form-label" for="username">Username</label>
              <input type="text" id="username" class="form-control" required>
            </div>

            <div class="form-group">
              <label class="form-label" for="email">Email Address</label>
              <input type="email" id="email" class="form-control" required>
            </div>

            <div class="d-flex justify-between mt-4">
              <div></div> <!-- spacer -->
              <button type="submit" class="btn btn-primary">Save Changes</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <script>
    const API_BASE = '../backend';
    const alertBox = document.getElementById('alert');

    function showAlert(msg, type = 'success') {
      alertBox.className = `alert alert-${type}`;
      alertBox.textContent = msg;
      alertBox.classList.remove('d-none');
    }

    // load profile
    fetch(`${API_BASE}/profile.php`, { credentials: 'include' })
      .then(r => {
        if (r.status === 401) {
          window.location.href = 'login.html';
          return;
        }
        return r.json();
      })
      .then(d => {
        if (!d || !d.success) return;
        document.getElementById('username').value = d.data.username;
        document.getElementById('email').value = d.data.email;
        const img = d.data.profile_pic || 'default.jpg';
        document.getElementById('profileImg').src = `../assets/profile/${img}`;
      });

    // update profile
    document.getElementById('profileForm').addEventListener('submit', function (e) {
      e.preventDefault();

      const payload = {
        username: document.getElementById('username').value.trim(),
        email: document.getElementById('email').value.trim()
      };

      fetch(`${API_BASE}/profile.php`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify(payload)
      })
        .then(r => r.json())
        .then(d => {
          if (d.success) showAlert(d.message, 'success');
          else showAlert(d.message || 'Failed to update profile', 'danger');
        });
    });

    // update photo
    document.getElementById('photoForm').addEventListener('submit', function (e) {
      e.preventDefault();

      const fileInput = document.getElementById('photo');
      if (!fileInput.files.length) {
        showAlert('Select a file first', 'danger');
        return;
      }

      const formData = new FormData();
      formData.append('photo', fileInput.files[0]);

      fetch(`${API_BASE}/profile_photo.php`, {
        method: 'POST',
        credentials: 'include',
        body: formData
      })
        .then(r => r.json())
        .then(d => {
          if (d.success) {
            showAlert(d.message, 'success');
            document.getElementById('profileImg').src = `../assets/profile/${d.file}`;
            fileInput.value = ''; // Reset file input
          } else {
            showAlert(d.message || 'Failed to update photo', 'danger');
          }
        });
    });

    document.getElementById('btnLogout').addEventListener('click', () => {
      fetch(`${API_BASE}/logout.php`, { credentials: 'include' })
        .then(() => window.location.href = 'login.html');
    });
  </script>
</body>

</html>