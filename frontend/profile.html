<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>User Profile - Cyber Report RMS</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background-color:#f3f4f6; }
    .rms-card { border-radius:6px; box-shadow:0 0.5rem 1rem rgba(15,23,42,.12); }
  </style>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-dark" style="background-color:#111827;">
  <div class="container-fluid">
    <a class="navbar-brand" href="reports.html">Cyber Incident Reporting RMS</a>
    <div class="collapse navbar-collapse">
      <ul class="navbar-nav me-auto">
        <li class="nav-item"><a class="nav-link" href="reports.html">Reports</a></li>
        <li class="nav-item"><a class="nav-link active" href="profile.html">Profile</a></li>
      </ul>
      <button id="btnLogout" class="btn btn-outline-light btn-sm">Logout</button>
    </div>
  </div>
</nav>

<div class="container py-4">
  <div id="alert" class="alert d-none" role="alert"></div>

  <div class="row g-4">
    <div class="col-md-4">
      <div class="card rms-card text-center">
        <div class="card-body">
          <h5 class="card-title mb-3">Profile Photo</h5>
          <img id="profileImg" src="../assets/profile/default.jpg" class="rounded-circle mb-3" width="140" height="140" alt="Profile">
          <form id="photoForm" enctype="multipart/form-data">
            <input type="file" name="photo" id="photo" class="form-control mb-2" accept="image/*">
            <button type="submit" class="btn btn-primary w-100 btn-sm">Update Photo</button>
          </form>
        </div>
      </div>
    </div>

    <div class="col-md-8">
      <div class="card rms-card">
        <div class="card-body">
          <h5 class="card-title mb-3">Account Details</h5>
          <form id="profileForm">
            <div class="mb-3">
              <label class="form-label" for="username">Username</label>
              <input type="text" id="username" class="form-control" required>
            </div>
            <div class="mb-3">
              <label class="form-label" for="email">Email</label>
              <input type="email" id="email" class="form-control" required>
            </div>
            <button type="submit" class="btn btn-primary">Save Changes</button>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
const API_BASE = '../backend';
const alertBox = document.getElementById('alert');

function showAlert(msg, type='success') {
  alertBox.className = 'alert alert-' + type;
  alertBox.textContent = msg;
  alertBox.classList.remove('d-none');
}

// load profile
fetch(`${API_BASE}/profile.php`, { credentials:'include' })
  .then(r => {
    if (r.status === 401) {
      window.location.href = 'login.html';
      return;
    }
    return r.json();
  })
  .then(d => {
    if (!d || !d.success) return;
    document.getElementById('username').value = d.data.username;
    document.getElementById('email').value    = d.data.email;
    const img = d.data.profile_pic || 'default.jpg';
    document.getElementById('profileImg').src = `../assets/profile/${img}`;
  });

// update profile
document.getElementById('profileForm').addEventListener('submit', function (e) {
  e.preventDefault();

  const payload = {
    username: document.getElementById('username').value.trim(),
    email: document.getElementById('email').value.trim()
  };

  fetch(`${API_BASE}/profile.php`, {
    method:'POST',
    headers:{ 'Content-Type':'application/json' },
    credentials:'include',
    body:JSON.stringify(payload)
  })
    .then(r => r.json())
    .then(d => {
      if (d.success) showAlert(d.message, 'success');
      else showAlert(d.message || 'Failed to update profile', 'danger');
    });
});

// update photo
document.getElementById('photoForm').addEventListener('submit', function (e) {
  e.preventDefault();

  const fileInput = document.getElementById('photo');
  if (!fileInput.files.length) {
    showAlert('Select a file first', 'danger');
    return;
  }

  const formData = new FormData();
  formData.append('photo', fileInput.files[0]);

  fetch(`${API_BASE}/profile_photo.php`, {
    method:'POST',
    credentials:'include',
    body:formData
  })
    .then(r => r.json())
    .then(d => {
      if (d.success) {
        showAlert(d.message, 'success');
        document.getElementById('profileImg').src = `../assets/profile/${d.file}`;
      } else {
        showAlert(d.message || 'Failed to update photo', 'danger');
      }
    });
});

document.getElementById('btnLogout').addEventListener('click', () => {
  fetch(`${API_BASE}/logout.php`, { credentials:'include' })
    .then(() => window.location.href = 'login.html');
});
</script>
</body>
</html>
