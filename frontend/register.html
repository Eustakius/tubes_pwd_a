<!doctype html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Register - Cyber Report RMS</title>
  <link href="../assets/css/style.css" rel="stylesheet">
</head>

<body>

  <!-- Navbar -->
  <nav class="navbar">
    <div class="container d-flex align-center justify-between">
      <span class="nav-brand">Cyber Incident Reporting RMS</span>
    </div>
  </nav>

  <!-- Auth Container -->
  <div class="auth-container">
    <div class="card auth-card">
      <h2 class="text-center mb-4">Create Account</h2>
      <p class="text-center mb-4" style="color: var(--text-muted)">Join the secure reporting system</p>

      <div id="alert" class="alert d-none" role="alert"></div>

      <form id="registerForm" novalidate>
        <div class="form-group">
          <label class="form-label" for="username">Username</label>
          <input type="text" id="username" class="form-control" placeholder="johndoe" required>
          <small id="usernameHelp" class="form-label mt-4" style="margin-top: 0.25rem; font-size: 0.8rem;"></small>
        </div>

        <div class="form-group">
          <label class="form-label" for="email">Email Address</label>
          <input type="email" id="email" class="form-control" placeholder="name@example.com" required>
          <small id="emailHelp" class="form-label" style="margin-top: 0.25rem; font-size: 0.8rem;"></small>
        </div>

        <div class="form-group">
          <label class="form-label" for="password">Password</label>
          <input type="password" id="password" class="form-control" placeholder="Minimum 6 characters" minlength="6"
            required>
        </div>

        <button type="submit" class="btn btn-primary w-100">Register</button>
      </form>

      <p class="mt-4 text-center text-muted" style="font-size: 0.9rem">
        Already have an account? <a href="login.html">Sign In</a>
      </p>
    </div>
  </div>

  <script>
    const API_BASE = '../backend';
    const usernameInput = document.getElementById('username');
    const emailInput = document.getElementById('email');
    const usernameHelp = document.getElementById('usernameHelp');
    const emailHelp = document.getElementById('emailHelp');
    const alertBox = document.getElementById('alert');

    function setHelp(el, msg, ok) {
      el.textContent = msg;
      el.classList.remove('text-danger', 'text-success');
      el.classList.add(ok ? 'text-success' : 'text-danger');
    }

    // realtime duplicate check
    usernameInput.addEventListener('blur', () => {
      const value = usernameInput.value.trim();
      if (!value) return;
      fetch(`${API_BASE}/register.php?username=${encodeURIComponent(value)}`)
        .then(r => r.json())
        .then(d => {
          setHelp(usernameHelp, d.available ? 'Username available' : 'Username already in use', d.available);
        });
    });

    emailInput.addEventListener('blur', () => {
      const value = emailInput.value.trim();
      if (!value) return;
      fetch(`${API_BASE}/register.php?email=${encodeURIComponent(value)}`)
        .then(r => r.json())
        .then(d => {
          setHelp(emailHelp, d.available ? 'Email available' : 'Email already in use', d.available);
        });
    });

    document.getElementById('registerForm').addEventListener('submit', function (e) {
      e.preventDefault();

      const payload = {
        username: usernameInput.value.trim(),
        email: emailInput.value.trim(),
        password: document.getElementById('password').value
      };

      fetch(`${API_BASE}/register.php`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      })
        .then(r => r.json())
        .then(d => {
          alertBox.classList.remove('d-none', 'alert-danger', 'alert-success');
          if (d.success) {
            alertBox.classList.add('alert-success');
            alertBox.textContent = d.message;
            this.reset();
            usernameHelp.textContent = '';
            emailHelp.textContent = '';
          } else {
            alertBox.classList.add('alert-danger');
            alertBox.textContent = d.message || 'Registration failed';
          }
        })
        .catch(() => {
          alertBox.classList.remove('d-none');
          alertBox.classList.add('alert-danger');
          alertBox.textContent = 'Unable to reach server';
        });
    });
  </script>
</body>

</html>