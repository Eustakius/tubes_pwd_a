<!doctype html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Incident Reports - Cyber Report RMS</title>
  <link href="../assets/css/style.css" rel="stylesheet">
</head>

<body>

  <!-- Navbar -->
  <nav class="navbar">
    <div class="container d-flex align-center justify-between">
      <span class="nav-brand">Cyber Incident Reporting RMS</span>
      <div class="d-flex align-center gap-4">
        <a href="reports.html" class="nav-link active">Reports</a>
        <a href="profile.html" class="nav-link">Profile</a>
        <button id="btnLogout" class="btn btn-secondary btn-sm" style="margin-left: 1rem;">Logout</button>
      </div>
    </div>
  </nav>

  <div class="container mb-4">
    <div id="alert" class="alert d-none" role="alert"></div>

    <div class="dashboard-layout">
      <!-- Left Column: Form -->
      <div>
        <div class="card">
          <h3 class="mb-4" style="font-size: 1.25rem;">New / Edit Report</h3>

          <form id="reportForm">
            <input type="hidden" id="reportId">
            <input type="hidden" id="latitude">
            <input type="hidden" id="longitude">

            <div class="form-group">
              <label class="form-label" for="title">Title</label>
              <input type="text" id="title" class="form-control" required placeholder="Brief title of incident">
            </div>

            <div class="form-group">
              <label class="form-label" for="description">Description</label>
              <textarea id="description" class="form-control" rows="3" required></textarea>
            </div>

            <div class="grid-layout" style="grid-template-columns: 1fr 1fr; gap: 1rem;">
              <div class="form-group">
                <label class="form-label">Category</label>
                <select id="category" class="form-control">
                  <option value="Hardware">Hardware</option>
                  <option value="Software">Software</option>
                  <option value="Network">Network</option>
                  <option value="Facility">Facility</option>
                  <option value="Security">Security</option>
                  <option value="Other" selected>Other</option>
                </select>
              </div>
              <div class="form-group">
                <label class="form-label">Priority</label>
                <select id="priority" class="form-control">
                  <option value="Low" selected>Low</option>
                  <option value="Medium">Medium</option>
                  <option value="High">High</option>
                  <option value="Critical">Critical</option>
                </select>
              </div>
            </div>

            <div class="form-group">
              <label class="form-label">Location (Auto/Manual)</label>
              <div class="d-flex gap-2">
                <input type="text" id="location" class="form-control" placeholder="Coordinates or Location Name"
                  required>
                <button type="button" class="btn btn-secondary" id="btnGeo">üìç Auto</button>
              </div>
              <input type="hidden" id="latitude">
              <input type="hidden" id="longitude">
            </div>

            <div class="form-group">
              <label class="form-label">Evidence (Image/PDF)</label>
              <input type="file" id="evidence" class="form-control" accept="image/*,application/pdf">
              <small class="text-muted">Max 2MB. Optional.</small>

              <!-- Progress Bar for Report -->
              <div id="reportProgressContainer" class="d-none mt-2">
                <div class="progress">
                  <div id="reportProgressBar" class="progress-bar bg-success" style="width: 0%"></div>
                </div>
                <small class="text-muted" id="reportProgressText">Uploading...</small>
              </div>

              <div class="mt-4">
                <button type="submit" id="btnSaveReport" class="btn btn-primary w-100">Save Report</button>
                <button type="button" id="btnCancelEdit" class="btn btn-secondary w-100 mt-2 d-none">Cancel
                  Edit</button>
              </div>
          </form>
        </div>
      </div>

      <!-- Right Column: List -->
      <div>
        <div class="card">
          <div class="d-flex justify-between align-center mb-4">
            <h3 style="font-size: 1.25rem;">My Incident Reports</h3>
          </div>

          <div class="table-container">
            <table class="table">
              <thead>
                <tr>
                  <th>#</th>
                  <th>Title</th>
                  <th>Status</th>
                  <th>Evidence</th>
                  <th>Created</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="reportsBody"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
  <!-- Discussion Modal -->
  <div id="discussModal" class="modal-overlay">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title">Discussion</div>
        <button class="modal-close" onclick="closeModal()">√ó</button>
      </div>
      <div class="modal-body" style="flex: 1; display: flex; flex-direction: column; overflow: hidden;">
        <div id="chatContainer" class="chat-container"
          style="flex: 1; overflow-y: auto; padding-right: 0.5rem; margin-bottom: 1rem;">
          <!-- Komentar chat akan muncul di sini (Dynamic Content) -->
        </div>

        <form id="commentForm" style="display: flex; gap: 0.5rem; margin-top: auto; flex-wrap: wrap;">
          <input type="hidden" id="chatReportId">
          <input type="text" id="commentInput" class="form-control" placeholder="Type a message..." required
            autocomplete="off" style="flex: 1;">
          <input type="file" id="chatAttachment" class="form-control" accept="image/*,application/pdf,video/*"
            style="flex-basis: 100%; margin-top: 0.5rem;">
          <small class="text-muted" style="flex-basis: 100%; font-size:0.8rem;">Max 2MB. Optional.</small>

          <!-- Progress Bar for Chat -->
          <div id="uploadProgress" class="d-none mt-2" style="flex-basis: 100%;">
            <div class="progress">
              <div id="progressBar" class="progress-bar bg-info" style="width: 0%"></div>
            </div>
            <small class="text-muted" id="progressText">Uploading...</small>
          </div>

          <button type="submit" id="btnSendChat" class="btn btn-primary"
            style="padding: 0 1.25rem; margin-top: 0.5rem;">Send</button>
        </form>
      </div>
    </div>
  </div>

  <script>
    const API_BASE = '../backend';
    const alertBox = document.getElementById('alert');
    const reportsBody = document.getElementById('reportsBody');
    let currentUser = null;

    function showAlert(msg, type = 'success') {
      alertBox.className = `alert alert-${type}`;
      alertBox.textContent = msg;
      alertBox.classList.remove('d-none');
    }

    // Verifikasi autentikasi sesi sebelum memuat halaman (Security Check)
    fetch(`${API_BASE}/me.php`, { credentials: 'include' })
      .then(r => r.json())
      .then(d => {
        if (!d.authenticated) {
          window.location.href = 'login.html';
        } else if (d.data.role === 'admin') {
          window.location.href = 'admin.html';
        } else {
          currentUser = d.data; // Menyimpan data user saat ini untuk styling chat (Client-side Session)
          loadReports();
        }
      });

    function statusColor(status) {
      switch (status) {
        case 'open': return 'warning';
        case 'progress': return 'info';
        case 'closed': return 'success';
        default: return 'secondary';
      }
    }

    function loadReports() {
      fetch(`${API_BASE}/crud_reports.php`, { credentials: 'include' })
        .then(r => r.json())
        .then(d => {
          reportsBody.innerHTML = '';
          if (d.success && Array.isArray(d.data)) {
            if (d.data.length === 0) {
              reportsBody.innerHTML = '<tr><td colspan="8" class="text-center p-4">No reports found</td></tr>';
            } else {
              d.data.forEach((rep, idx) => {
                const evidenceLink = rep.evidence
                  ? `<a href="../backend/uploads/${rep.evidence}" target="_blank" style="text-decoration: underline;">View</a>`
                  : '-';

                let actionBtns = '';
                if (rep.status !== 'closed') {
                  actionBtns = `
                      <button class="btn btn-secondary btn-sm" onclick="editReport(${rep.id})" style="padding: 0.2rem 0.5rem">Edit</button>
                      <button class="btn btn-danger btn-sm" onclick="deleteReport(${rep.id})" style="padding: 0.2rem 0.5rem; margin-left: 4px;">Del</button>
                    `;
                } else {
                  actionBtns = `<span style="font-size:0.8rem; color:var(--text-muted); margin-right:4px;">Closed</span>`;
                }

                const tr = document.createElement('tr');
                tr.innerHTML = `
              <td>${idx + 1}</td>
              <td style="font-weight: 500;">${rep.title}</td>
              <td>${rep.category || '-'}</td>
              <td><span class="badge ${getPriorityBadge(rep.priority)}">${rep.priority}</span></td>
              <td><span class="badge badge-${statusColor(rep.status)}">${rep.status}</span></td>
              <td>${evidenceLink}</td>
              <td style="font-size: 0.85rem; color: var(--text-muted);">${rep.created_at.substring(0, 16)}</td>
              <td>
                ${actionBtns}
                ${getChatButton(rep)}
              </td>
            `;
                reportsBody.appendChild(tr);
              });
            }
          }
        });
    }

    function getChatButton(rep) {
      let badge = '';
      // Notifikasi: Jika balasan terakhir adalah admin, tampilkan indikator
      if (rep.last_reply_by === 'admin') {
        badge = `<span style="position:absolute; top:-5px; right:-5px; width:10px; height:10px; background:red; border-radius:50%; border:2px solid white;"></span>`;
      }
      return `<button class="btn btn-primary btn-sm" onclick="openDiscussion(${rep.id}, '${rep.title}', '${rep.status}')" style="padding: 0.2rem 0.5rem; margin-left: 4px; position:relative;">Chat ${badge}</button>`;
    }

    function getPriorityBadge(p) {
      if (p === 'Critical') return 'badge-danger'; // Perlu mendefinisikan style ini atau menggunakan ulang 'danger'
      if (p === 'High') return 'badge-warning';
      if (p === 'Medium') return 'badge-info';
      return 'badge-secondary'; // Low
    }

    // --- Logika Modal dan Komentar (UI Interactivity) ---
    const discussModal = document.getElementById('discussModal');
    const chatContainer = document.getElementById('chatContainer');
    const commentInput = document.getElementById('commentInput');

    let pollInterval = null;

    function openDiscussion(reportId, title, status) {
      document.querySelector('.modal-title').textContent = 'Discuss: ' + title;
      document.getElementById('chatReportId').value = reportId;

      const input = document.getElementById('commentInput');
      const fileInput = document.getElementById('chatAttachment');
      const btn = document.getElementById('btnSendChat');

      if (status === 'closed') {
        input.disabled = true;
        input.placeholder = 'Ticket is closed. Cannot reply.';
        fileInput.disabled = true;
        btn.disabled = true;
        btn.style.opacity = 0.5;
      } else {
        input.disabled = false;
        input.placeholder = 'Type a message...';
        fileInput.disabled = false;
        btn.disabled = false;
        btn.style.opacity = 1;
      }

      discussModal.classList.add('active');
      // Initial Load
      chatContainer.innerHTML = '<div class="text-center text-muted">Loading...</div>';
      loadComments(reportId);

      // Polling Real-time (Interval 3 detik)
      if (pollInterval) clearInterval(pollInterval);
      pollInterval = setInterval(() => {
        if (discussModal.classList.contains('active')) {
          loadComments(reportId, true); // Mode senyap (Background Update)
        }
      }, 3000);
    }

    function closeModal() {
      discussModal.classList.remove('active');
      if (pollInterval) clearInterval(pollInterval);
    }

    function renderComment(c) {
      const isSelf = (c.user_id == currentUser.id);
      let mediaContent = '';
      if (c.attachment) {
        const ext = c.attachment.split('.').pop().toLowerCase();
        if (['jpg', 'jpeg', 'png', 'gif'].includes(ext)) {
          mediaContent = `<div style="margin-top:5px;"><a href="../backend/uploads/${c.attachment}" target="_blank"><img src="../backend/uploads/${c.attachment}" style="max-width:200px; border-radius:4px;"></a></div>`;
        } else if (['mp4', 'webm'].includes(ext)) {
          mediaContent = `<div style="margin-top:5px;"><video src="../backend/uploads/${c.attachment}" controls style="max-width:200px; border-radius:4px;"></video></div>`;
        } else {
          mediaContent = `<div style="margin-top:5px;"><a href="../backend/uploads/${c.attachment}" target="_blank" class="btn btn-sm btn-secondary">Download File</a></div>`;
        }
      }

      return `
        <div class="chat-message ${isSelf ? 'self' : ''}">
            <div style="display:flex; flex-direction:column; align-items: ${isSelf ? 'flex-end' : 'flex-start'}; max-width: 100%;">
                <div class="chat-bubble">
                    ${c.message || ''}
                    ${mediaContent}
                </div>
                <div class="chat-meta">
                    ${isSelf ? 'You' : c.username} ‚Ä¢ ${c.created_at.substring(11, 16)}
                </div>
            </div>
        </div>
       `;
    }

    function loadComments(reportId, silent = false) {
      fetch(`${API_BASE}/crud_comments.php?report_id=${reportId}`, { credentials: 'include' })
        .then(r => r.json())
        .then(d => {
          if (d.success && d.data) {
            // Implementasi Dasar: Render ulang semua elemen.
            // Untuk kehalusan, bisa menggunakan diffing, namun saat ini replace innerHTML sudah cukup.
            // User menginginkan pengalaman real-time.
            // Karena kita append instan saat kirim, polling hanya menambahkan pesan ORANG LAIN.

            // Cara paling sederhana dan halus: bandingkan panjang data?
            // Render ulang seluruh string HTML.
            // Jika sedang mengetik, replace innerHTML mungkin mengganggu posisi scroll?
            // Reset scrollTop HANYA jika sebelumnya berada di bawah.

            const wasAtBottom = (chatContainer.scrollHeight - chatContainer.scrollTop === chatContainer.clientHeight);

            let html = '';
            if (d.data.length === 0) {
              html = '<div class="text-center text-muted mt-4">No comments yet. Start the discussion!</div>';
            } else {
              d.data.forEach(c => {
                html += renderComment(c);
              });
            }

            chatContainer.innerHTML = html;

            if (!silent || wasAtBottom) {
              chatContainer.scrollTop = chatContainer.scrollHeight;
            }
          }
        });
    }

    document.getElementById('commentForm').addEventListener('submit', function (e) {
      e.preventDefault();
      const msg = commentInput.value.trim();
      const fileInput = document.getElementById('chatAttachment');
      const rid = document.getElementById('chatReportId').value;
      const btnSend = document.getElementById('btnSendChat');
      const progressContainer = document.getElementById('uploadProgress');
      const progressBar = document.getElementById('progressBar');

      if (!rid) {
        showAlert('Error: Report ID not found. Please re-open the chat.', 'danger');
        return;
      }

      // Allow empty message if there is a file
      if (!msg && !fileInput.files[0]) {
        showAlert('Please enter a message or select a file.', 'danger');
        return;
      }

      // VALIDATION: File Size (2MB)
      if (fileInput.files[0] && fileInput.files[0].size > 2 * 1024 * 1024) {
        showAlert('File size exceeds 2MB limit.', 'danger');
        return;
      }

      const formData = new FormData();
      formData.append('report_id', rid);
      formData.append('message', msg);
      if (fileInput.files[0]) {
        formData.append('attachment', fileInput.files[0]);
      }

      // UI Reset
      btnSend.disabled = true;
      btnSend.textContent = 'Sending...';
      progressContainer.classList.remove('d-none');
      progressBar.style.width = '0%';

      // Menggunakan XHR untuk Progress Bar Upload
      const xhr = new XMLHttpRequest();
      xhr.open('POST', `${API_BASE}/crud_comments.php`, true);
      xhr.withCredentials = true;

      xhr.upload.onprogress = function (e) {
        if (e.lengthComputable) {
          const percent = (e.loaded / e.total) * 100;
          progressBar.style.width = percent + '%';
        }
      };

      xhr.onload = function () {
        btnSend.disabled = false;
        btnSend.textContent = 'Send';
        progressContainer.classList.add('d-none');

        if (xhr.status === 200) {
          try {
            const d = JSON.parse(xhr.responseText);
            if (d.success) {
              commentInput.value = '';
              fileInput.value = '';

              // INSTANT UI UPDATE
              // Jika backend mengembalikan objek 'comment', gunakan itu!
              if (d.comment) {
                const html = renderComment(d.comment);
                // Check if "No comments" placeholder exists and remove it
                if (chatContainer.innerHTML.includes('No comments yet')) {
                  chatContainer.innerHTML = '';
                }
                chatContainer.innerHTML += html;
                chatContainer.scrollTop = chatContainer.scrollHeight;
              } else {
                // Fallback jika backend tidak mengembalikan status (seharusnya sekarang sudah)
                loadComments(rid);
              }

            } else {
              showAlert('Error: ' + d.message, 'danger');
            }
          } catch (e) {
            console.error(e);
            showAlert('Invalid response from server', 'danger');
          }
        } else {
          showAlert('Upload failed: ' + xhr.statusText, 'danger');
        }
      };

      xhr.onerror = function () {
        btnSend.disabled = false;
        btnSend.textContent = 'Send';
        progressContainer.classList.add('d-none');
        showAlert('Network Error', 'danger');
      };

      xhr.send(formData);
    });

    // Menutup modal saat klik area luar (Event Listener)
    discussModal.addEventListener('click', (e) => {
      if (e.target === discussModal) closeModal();
    });

    // Menangani Pembuatan/Pembaruan Laporan
    document.getElementById('reportForm').addEventListener('submit', function (e) {
      e.preventDefault();

      const id = document.getElementById('reportId').value;
      const title = document.getElementById('title').value.trim();
      const btnSave = document.getElementById('btnSaveReport');
      const progressContainer = document.getElementById('reportProgressContainer');
      const progressBar = document.getElementById('reportProgressBar');

      if (!title) {
        showAlert('Title is required', 'danger');
        return;
      }

      const fileInput = document.getElementById('evidence');
      // VALIDATION: File Size (2MB)
      if (fileInput.files[0] && fileInput.files[0].size > 2 * 1024 * 1024) {
        showAlert('File size exceeds 2MB limit.', 'danger');
        return;
      }

      const url = id ? `${API_BASE}/crud_reports.php?id=${id}` : `${API_BASE}/crud_reports.php`;

      const isUpdate = !!id;

      // SELALU gunakan POST karena crud_reports.php menangani Create/Update via POST (cek query ?id)
      // dan PHP standar tidak memparsing body PUT secara otomatis.
      const finalMethod = 'POST';

      // UI Reset
      btnSave.disabled = true;
      btnSave.textContent = 'Uploading...';
      progressContainer.classList.remove('d-none');
      progressBar.style.width = '0%';

      const xhr = new XMLHttpRequest();
      xhr.open(finalMethod, url, true);
      xhr.withCredentials = true;

      xhr.upload.onprogress = function (e) {
        if (e.lengthComputable) {
          const percent = (e.loaded / e.total) * 100;
          progressBar.style.width = percent + '%';
        }
      };

      xhr.onload = function () {
        btnSave.disabled = false;
        btnSave.textContent = 'Save Report';
        progressContainer.classList.add('d-none');

        if (xhr.status === 200) {
          try {
            const d = JSON.parse(xhr.responseText);
            if (d.success) {
              showAlert(d.message || (isUpdate ? 'Report updated' : 'Report created'));
              document.getElementById('reportForm').reset();
              document.getElementById('reportId').value = '';
              document.getElementById('btnCancelEdit').classList.add('d-none');
              loadReports();
            } else {
              showAlert(d.message || 'Operation failed', 'danger');
            }
          } catch (e) {
            console.error(e);
            showAlert('Invalid response from server', 'danger');
          }
        } else {
          showAlert('Upload failed: ' + xhr.statusText, 'danger');
        }
      };

      xhr.onerror = function () {
        btnSave.disabled = false;
        btnSave.textContent = 'Save Report';
        progressContainer.classList.add('d-none');
        showAlert('Network Error', 'danger');
      };

      // Membangun Payload Data (FormData)
      const formData = new FormData();
      formData.append('title', title);
      formData.append('description', document.getElementById('description').value.trim());
      formData.append('category', document.getElementById('category').value);
      formData.append('priority', document.getElementById('priority').value);
      formData.append('location', document.getElementById('location').value.trim());
      formData.append('latitude', document.getElementById('latitude').value);
      formData.append('longitude', document.getElementById('longitude').value);

      if (fileInput.files[0]) {
        formData.append('evidence', fileInput.files[0]);
      }

      xhr.send(formData);
    });

    document.getElementById('btnGeo').addEventListener('click', () => {
      const btn = document.getElementById('btnGeo');
      btn.disabled = true;
      btn.textContent = '‚è≥ Locating...';

      if (!navigator.geolocation) {
        showAlert('Geolocation is not supported by this browser.', 'danger');
        btn.disabled = false;
        btn.textContent = 'üìç Auto';
        return;
      }

      navigator.geolocation.getCurrentPosition(
        pos => {
          const lat = pos.coords.latitude.toFixed(6);
          const lng = pos.coords.longitude.toFixed(6);
          document.getElementById('location').value = `${lat},${lng}`;
          document.getElementById('latitude').value = lat;
          document.getElementById('longitude').value = lng;
          btn.disabled = false;
          btn.textContent = 'üìç Auto';
          showAlert('Location found!', 'success');
        },
        err => {
          btn.disabled = false;
          btn.textContent = 'üìç Auto';
          let msg = 'Unknown error';
          switch (err.code) {
            case err.PERMISSION_DENIED: msg = 'User denied request. Allow location in browser settings.'; break;
            case err.POSITION_UNAVAILABLE: msg = 'Location info unavailable.'; break;
            case err.TIMEOUT: msg = 'Request timed out.'; break;
          }
          showAlert('Loc Error: ' + msg, 'danger');
        },
        { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
      );
    });

    // Mendefinisikan fungsi editReport secara global
    window.editReport = function (id) {
      document.getElementById('reportForm').reset();

      fetch(`${API_BASE}/crud_reports.php?id=${id}`, { credentials: 'include' })
        .then(r => r.json())
        .then(d => {
          if (d.success && d.data) {
            const rep = d.data;
            document.getElementById('reportId').value = rep.id;
            document.getElementById('title').value = rep.title;
            document.getElementById('description').value = rep.description;
            document.getElementById('category').value = rep.category || 'Other';
            document.getElementById('priority').value = rep.priority || 'Low';
            document.getElementById('location').value = rep.location || '';
            document.getElementById('latitude').value = rep.latitude || '';
            document.getElementById('longitude').value = rep.longitude || '';

            document.getElementById('btnCancelEdit').classList.remove('d-none');
            window.scrollTo({ top: 0, behavior: 'smooth' });
          } else {
            showAlert('Failed to load report data', 'danger');
          }
        })
        .catch(err => console.error(err));
    };

    // Batalkan Edit (Reset Form)
    document.getElementById('btnCancelEdit').addEventListener('click', function () {
      document.getElementById('reportForm').reset();
      document.getElementById('reportId').value = '';
      this.classList.add('d-none');
    });

    // Hapus Laporan
    window.deleteReport = function (id) {
      if (!confirm('Delete this report?')) return;
      fetch(`${API_BASE}/crud_reports.php?id=${id}`, {
        method: 'DELETE',
        credentials: 'include'
      })
        .then(r => r.json())
        .then(d => {
          if (d.success) {
            showAlert('Report deleted');
            loadReports();
          } else {
            showAlert(d.message || 'Failed to delete', 'danger');
          }
        });
    };

    // Proses Logout (Session Destruction)
    document.getElementById('btnLogout').addEventListener('click', () => {
      fetch(`${API_BASE}/logout.php`, { credentials: 'include' })
        .then(() => window.location.href = 'login.html');
    });

  </script>
</body>

</html>